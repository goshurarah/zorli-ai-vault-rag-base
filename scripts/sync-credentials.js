#!/usr/bin/env node

/**
 * Credential Sync Script for Zorli AI Vault
 * 
 * This script helps synchronize credentials between:
 * 1. Replit Secrets panel 
 * 2. Local .env file
 * 
 * Usage:
 *   node scripts/sync-credentials.js --help
 *   node scripts/sync-credentials.js --env-to-replit   # Copy .env to Replit Secrets
 *   node scripts/sync-credentials.js --replit-to-env   # Copy Replit Secrets to .env
 *   node scripts/sync-credentials.js --status          # Show current status
 */

import fs from 'fs';
import path from 'path';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Environment variables that should be synced
const SYNC_VARIABLES = [
  'DATABASE_URL',
  'NEXT_PUBLIC_SUPABASE_URL', 
  'NEXT_PUBLIC_SUPABASE_ANON_KEY',
  'SUPABASE_SERVICE_ROLE_KEY',
  'OPENAI_API_KEY',
  'VITE_STRIPE_PUBLIC_KEY',
  'STRIPE_SECRET_KEY',
  'TESTING_VITE_STRIPE_PUBLIC_KEY',
  'TESTING_STRIPE_SECRET_KEY',
  'DEFAULT_OBJECT_STORAGE_BUCKET_ID',
  'PUBLIC_OBJECT_SEARCH_PATHS',
  'PRIVATE_OBJECT_DIR',
  'SESSION_SECRET',
  'PGDATABASE',
  'PGHOST',
  'PGPORT',
  'PGUSER',
  'PGPASSWORD'
];

const ENV_FILE_PATH = path.join(process.cwd(), '.env');
const ENV_EXAMPLE_PATH = path.join(process.cwd(), '.env.example');

/**
 * Parse .env file into key-value object
 */
function parseEnvFile(filePath) {
  if (!fs.existsSync(filePath)) {
    return {};
  }
  
  const content = fs.readFileSync(filePath, 'utf-8');
  const vars = {};
  
  content.split('\n').forEach(line => {
    line = line.trim();
    if (line && !line.startsWith('#') && line.includes('=')) {
      const [key, ...valueParts] = line.split('=');
      vars[key.trim()] = valueParts.join('=').trim();
    }
  });
  
  return vars;
}

/**
 * Get current Replit secrets (returns array of secret names)
 */
function getReplitSecrets() {
  try {
    const output = execSync('replit secrets list', { encoding: 'utf-8' });
    // Parse "KEY=VALUE" format and extract just the keys
    return output.trim().split('\n')
      .filter(Boolean)
      .map(line => line.split('=')[0].trim())
      .filter(Boolean);
  } catch (error) {
    console.warn('‚ö†Ô∏è  Replit secrets CLI not available in this environment.');
    console.log('üí° You can still use this script to manage your .env file.');
    // Return environment variables that exist as fallback
    return SYNC_VARIABLES.filter(variable => process.env[variable]);
  }
}

/**
 * Set a Replit secret
 */
function setReplitSecret(key, value) {
  try {
    execSync(`replit secrets set "${key}=${value}"`, { stdio: 'pipe' });
    return true;
  } catch (error) {
    console.warn(`‚ö†Ô∏è  Cannot set Replit secret ${key}: CLI not available`);
    console.log(`üí° You can set this manually in the Replit Secrets panel: ${key}`);
    return false;
  }
}

/**
 * Write environment variables to .env file
 */
function writeEnvFile(vars) {
  let content = `# Zorli AI Vault - Environment Variables
# This file contains your actual credentials
# DO NOT commit this file to version control
# Generated by sync-credentials.js on ${new Date().toISOString()}

# =================
# DATABASE
# =================
DATABASE_URL=${vars.DATABASE_URL || ''}

# =================
# SUPABASE
# =================
NEXT_PUBLIC_SUPABASE_URL=${vars.NEXT_PUBLIC_SUPABASE_URL || ''}
NEXT_PUBLIC_SUPABASE_ANON_KEY=${vars.NEXT_PUBLIC_SUPABASE_ANON_KEY || ''}
SUPABASE_SERVICE_ROLE_KEY=${vars.SUPABASE_SERVICE_ROLE_KEY || ''}

# =================
# OPENAI
# =================
OPENAI_API_KEY=${vars.OPENAI_API_KEY || ''}

# =================
# STRIPE (PAYMENTS)
# =================
VITE_STRIPE_PUBLIC_KEY=${vars.VITE_STRIPE_PUBLIC_KEY || ''}
STRIPE_SECRET_KEY=${vars.STRIPE_SECRET_KEY || ''}
TESTING_VITE_STRIPE_PUBLIC_KEY=${vars.TESTING_VITE_STRIPE_PUBLIC_KEY || ''}
TESTING_STRIPE_SECRET_KEY=${vars.TESTING_STRIPE_SECRET_KEY || ''}

# =================
# OBJECT STORAGE
# =================
DEFAULT_OBJECT_STORAGE_BUCKET_ID=${vars.DEFAULT_OBJECT_STORAGE_BUCKET_ID || ''}
PUBLIC_OBJECT_SEARCH_PATHS=${vars.PUBLIC_OBJECT_SEARCH_PATHS || ''}
PRIVATE_OBJECT_DIR=${vars.PRIVATE_OBJECT_DIR || ''}

# =================
# SESSION & SECURITY
# =================
SESSION_SECRET=${vars.SESSION_SECRET || ''}

# =================
# DATABASE CREDENTIALS (Auto-managed by Replit)
# =================
PGDATABASE=${vars.PGDATABASE || ''}
PGHOST=${vars.PGHOST || ''}
PGPORT=${vars.PGPORT || '5432'}
PGUSER=${vars.PGUSER || ''}
PGPASSWORD=${vars.PGPASSWORD || ''}

# =================
# DEVELOPMENT
# =================
NODE_ENV=development
`;

  fs.writeFileSync(ENV_FILE_PATH, content);
}

/**
 * Show current credential status
 */
function showStatus() {
  console.log('üîç Credential Sync Status\n');
  
  // Check .env file
  const envExists = fs.existsSync(ENV_FILE_PATH);
  console.log(`üìÅ .env file: ${envExists ? '‚úÖ Exists' : '‚ùå Missing'}`);
  
  if (envExists) {
    const envVars = parseEnvFile(ENV_FILE_PATH);
    const envCount = Object.keys(envVars).length;
    console.log(`   ‚îî‚îÄ Variables: ${envCount}`);
  }
  
  // Check Replit secrets
  try {
    const secrets = getReplitSecrets();
    console.log(`üîê Replit Secrets: ${secrets.length} secrets found`);
    
    // Check which sync variables exist
    console.log('\nüìã Sync Variables Status:');
    SYNC_VARIABLES.forEach(variable => {
      const inEnv = envExists ? parseEnvFile(ENV_FILE_PATH)[variable] : false;
      const inReplit = secrets.includes(variable);
      const status = inEnv && inReplit ? '‚úÖ' : inEnv ? 'üìÅ' : inReplit ? 'üîê' : '‚ùå';
      console.log(`   ${status} ${variable}`);
    });
    
    console.log('\nüìñ Legend:');
    console.log('   ‚úÖ Available in both .env and Replit Secrets');
    console.log('   üìÅ Only in .env file');
    console.log('   üîê Only in Replit Secrets');
    console.log('   ‚ùå Missing from both');
    
  } catch (error) {
    console.log('üîê Replit Secrets: ‚ùå Unable to access');
  }
}

/**
 * Sync from .env to Replit Secrets
 */
function syncEnvToReplit() {
  console.log('üì§ Syncing .env file to Replit Secrets...\n');
  
  if (!fs.existsSync(ENV_FILE_PATH)) {
    console.error('‚ùå .env file not found. Please create one first.');
    process.exit(1);
  }
  
  const envVars = parseEnvFile(ENV_FILE_PATH);
  let successCount = 0;
  let totalCount = 0;
  
  SYNC_VARIABLES.forEach(variable => {
    if (envVars[variable]) {
      totalCount++;
      console.log(`üîÑ Setting ${variable}...`);
      if (setReplitSecret(variable, envVars[variable])) {
        successCount++;
        console.log(`   ‚úÖ Success`);
      } else {
        console.log(`   ‚ùå Failed`);
      }
    }
  });
  
  console.log(`\n‚ú® Sync complete: ${successCount}/${totalCount} secrets updated`);
}

/**
 * Sync from Replit Secrets to .env
 */
function syncReplitToEnv() {
  console.log('üì• Syncing Replit Secrets to .env file...\n');
  
  const secrets = getReplitSecrets();
  const envVars = {};
  
  // Get current environment values for sync variables
  SYNC_VARIABLES.forEach(variable => {
    if (secrets.includes(variable)) {
      envVars[variable] = process.env[variable] || '';
      console.log(`‚úÖ Found ${variable}`);
    } else {
      console.log(`‚ö†Ô∏è  Missing ${variable}`);
    }
  });
  
  console.log(`\nüìù Writing ${Object.keys(envVars).length} variables to .env file...`);
  writeEnvFile(envVars);
  console.log('‚úÖ .env file updated successfully');
}

/**
 * Show help message
 */
function showHelp() {
  console.log(`
üîê Credential Sync Script for Zorli AI Vault

This script helps synchronize credentials between Replit Secrets and your local .env file.

USAGE:
  node scripts/sync-credentials.js [COMMAND]

COMMANDS:
  --status           Show current credential status
  --env-to-replit    Copy credentials from .env file to Replit Secrets  
  --replit-to-env    Copy credentials from Replit Secrets to .env file
  --help             Show this help message

EXAMPLES:
  # Check current status
  node scripts/sync-credentials.js --status
  
  # Update Replit Secrets from .env file (useful after editing .env)
  node scripts/sync-credentials.js --env-to-replit
  
  # Update .env file from Replit Secrets (useful for fresh setup)
  node scripts/sync-credentials.js --replit-to-env

IMPORTANT NOTES:
  ‚Ä¢ Always backup your credentials before syncing
  ‚Ä¢ .env file should never be committed to version control
  ‚Ä¢ Replit Secrets take precedence in the Replit environment
  ‚Ä¢ This script only syncs predefined variables (not all secrets)
`);
}

// Main execution
const args = process.argv.slice(2);
const command = args[0];

switch (command) {
  case '--status':
    showStatus();
    break;
  case '--env-to-replit':
    syncEnvToReplit();
    break;
  case '--replit-to-env':
    syncReplitToEnv();
    break;
  case '--help':
  default:
    showHelp();
    break;
}